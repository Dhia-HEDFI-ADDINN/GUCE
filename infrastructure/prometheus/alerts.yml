# =============================================================================
# E-GUCE 3G - Regles d'Alertes Prometheus
# =============================================================================
# Ces alertes sont utilisees par le Hub pour surveiller toutes les instances
# et par chaque instance pour son monitoring local.
# =============================================================================

groups:
  # ===========================================
  # ALERTES DE DISPONIBILITE
  # ===========================================
  - name: availability
    rules:
      - alert: InstanceDown
        expr: up == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Instance {{ $labels.instance }} indisponible"
          description: "L'instance {{ $labels.instance }} est DOWN depuis plus de 5 minutes."

      - alert: ServiceDown
        expr: probe_success == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Service {{ $labels.job }} indisponible"
          description: "Le service {{ $labels.job }} ne repond pas depuis 2 minutes."

      - alert: HighErrorRate
        expr: rate(http_server_requests_seconds_count{status=~"5.."}[5m]) / rate(http_server_requests_seconds_count[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Taux d'erreur eleve sur {{ $labels.instance }}"
          description: "Plus de 10% des requetes retournent une erreur 5xx."

  # ===========================================
  # ALERTES RESSOURCES
  # ===========================================
  - name: resources
    rules:
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "CPU eleve sur {{ $labels.instance }}"
          description: "L'utilisation CPU est superieure a 80% depuis 10 minutes."

      - alert: CriticalCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 95
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "CPU critique sur {{ $labels.instance }}"
          description: "L'utilisation CPU est superieure a 95% depuis 5 minutes."

      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Memoire elevee sur {{ $labels.instance }}"
          description: "L'utilisation memoire est superieure a 85% depuis 10 minutes."

      - alert: CriticalMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 95
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Memoire critique sur {{ $labels.instance }}"
          description: "L'utilisation memoire est superieure a 95% depuis 5 minutes."

      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 15
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Espace disque bas sur {{ $labels.instance }}"
          description: "Moins de 15% d'espace disque disponible."

      - alert: DiskSpaceCritical
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 5
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Espace disque critique sur {{ $labels.instance }}"
          description: "Moins de 5% d'espace disque disponible."

  # ===========================================
  # ALERTES BASE DE DONNEES
  # ===========================================
  - name: database
    rules:
      - alert: DatabaseConnectionFailed
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Connexion PostgreSQL echouee"
          description: "Impossible de se connecter a PostgreSQL depuis 1 minute."

      - alert: DatabaseHighConnections
        expr: pg_stat_activity_count / pg_settings_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Connexions DB elevees sur {{ $labels.instance }}"
          description: "Plus de 80% des connexions PostgreSQL sont utilisees."

      - alert: DatabaseReplicationLag
        expr: pg_stat_replication_pg_wal_lsn_diff > 100000000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Lag de replication PostgreSQL"
          description: "Le lag de replication depasse 100MB."

  # ===========================================
  # ALERTES PERFORMANCES
  # ===========================================
  - name: performance
    rules:
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_server_requests_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Temps de reponse eleve sur {{ $labels.instance }}"
          description: "Le P95 du temps de reponse depasse 2 secondes."

      - alert: CriticalResponseTime
        expr: histogram_quantile(0.95, rate(http_server_requests_seconds_bucket[5m])) > 5
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Temps de reponse critique sur {{ $labels.instance }}"
          description: "Le P95 du temps de reponse depasse 5 secondes."

      - alert: HighRequestRate
        expr: rate(http_server_requests_seconds_count[5m]) > 1000
        for: 5m
        labels:
          severity: info
        annotations:
          summary: "Trafic eleve sur {{ $labels.instance }}"
          description: "Plus de 1000 requetes par seconde."

  # ===========================================
  # ALERTES KAFKA
  # ===========================================
  - name: kafka
    rules:
      - alert: KafkaBrokerDown
        expr: kafka_brokers < 1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Broker Kafka indisponible"
          description: "Aucun broker Kafka disponible."

      - alert: KafkaConsumerLag
        expr: kafka_consumer_lag > 10000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Consumer lag Kafka eleve"
          description: "Le consumer lag depasse 10000 messages."

  # ===========================================
  # ALERTES KEYCLOAK
  # ===========================================
  - name: keycloak
    rules:
      - alert: KeycloakDown
        expr: keycloak_up == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Keycloak indisponible"
          description: "Le serveur Keycloak ne repond pas."

      - alert: KeycloakHighLoginFailures
        expr: rate(keycloak_login_error_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Echecs de connexion Keycloak eleves"
          description: "Plus de 10 echecs de connexion par seconde."

  # ===========================================
  # ALERTES CAMUNDA/ZEEBE
  # ===========================================
  - name: camunda
    rules:
      - alert: ZeebeDown
        expr: up{job="zeebe"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Zeebe indisponible"
          description: "Le moteur de workflow Zeebe ne repond pas."

      - alert: ZeebeHighBackpressure
        expr: zeebe_backpressure_requests_total > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Backpressure Zeebe elevee"
          description: "Zeebe est en situation de backpressure."

  # ===========================================
  # ALERTES METIER GUCE
  # ===========================================
  - name: guce_business
    rules:
      - alert: HighDeclarationProcessingTime
        expr: histogram_quantile(0.95, rate(declaration_processing_duration_seconds_bucket[1h])) > 300
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "Temps de traitement des declarations eleve"
          description: "Le P95 du temps de traitement des declarations depasse 5 minutes."

      - alert: DeclarationRejectionRateHigh
        expr: rate(declarations_rejected_total[1h]) / rate(declarations_submitted_total[1h]) > 0.2
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "Taux de rejet eleve"
          description: "Plus de 20% des declarations sont rejetees."

      - alert: NoDeclarationsProcessed
        expr: increase(declarations_processed_total[1h]) == 0
        for: 2h
        labels:
          severity: info
        annotations:
          summary: "Aucune declaration traitee"
          description: "Aucune declaration n'a ete traitee depuis 2 heures (periode ouvree a verifier)."
